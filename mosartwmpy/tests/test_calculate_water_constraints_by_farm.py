import unittest
import pandas as pd
import pkgutil

from mosartwmpy.farmer_abm.farmer_abm import FarmerABM
from mosartwmpy import Model


class CalculateWaterConstraintsByFarmTest(unittest.TestCase):

    CONFIG_FILE = pkgutil.get_data("mosartwmpy", "tests/test_config.yaml")

    def test_calculate_water_constraints_by_farm(self):
        model = Model()
        model.initialize(self.CONFIG_FILE)
        farmerABM = FarmerABM(model)

        land_water_constraints_by_farm_path = model.config.get('water_management.demand.farmer_abm.land_water_constraints.path')
        land_water_constraints_by_farm = pd.read_parquet(land_water_constraints_by_farm_path)
        water_constraints_by_farm = farmerABM.calculate_water_constraints_by_farm(land_water_constraints_by_farm)

        expected = {0: 30.953315307579384, 1: 56.31991141933154, 2: 3.0638493076259268, 3: 37.60833610699229, 4: 83.7961929898409, 5: 16.83338686681714, 
                    6: 237.35966229419915, 7: 2598.7091913113686, 8: 39.71815726622037, 9: 1833.5083552610017, 10: 231.90016577956803, 11: 5862.525128322937, 
                    12: 388.10877691498445, 13: 34.053781480849885, 14: 9.072237729152127, 15: 14007.633089778261, 16: 5379.013682074553, 17: 9.523888225889461, 
                    18: 19.853564748037, 19: 2.5976314866973436, 20: 226.93266144087923, 21: 21.23900104164071, 22: 12.385520049782132, 23: 74.46348552407855, 
                    24: 654.7202788173175, 25: 327.9151358507958, 26: 49.331258660350606, 27: 15.658859847981601, 28: 2.050472268986429, 29: 10.921335820710048, 
                    30: 0.0, 31: 9.138538327619356, 32: 85.7741310344013, 33: 211.5797469969084, 34: 608.3669081261504, 35: 484.0952382545909, 
                    36: 1176.3042993778172, 37: 2615.216044397955, 38: 3307.299794036779, 39: 3295.7305674509576, 40: 5659.959184232939, 41: 3119.1317828001297, 
                    42: 1698.7476451451569, 43: 1617.6026163775439, 44: 10837.539763179182, 45: 12196.711498637631, 46: 25450.62809850097, 47: 14621.085257372584, 
                    48: 370.8388238471635, 49: 123.13632715457454, 50: 8.323512859757498, 51: 3652.4126529340183, 52: 18174.9365444444, 53: 19144.127546798303, 
                    54: 1534.553615542034, 55: 220.74229489581606, 56: 277.4710702842115, 57: 0.09653429406007573, 58: 576.7987460402096, 59: 12.994297115392612, 
                    60: 0.772274352480606, 61: 1583.037073154523, 62: 1417.5396968282862, 63: 7363.408176769164, 64: 842.8043078659505, 65: 0.0, 
                    66: 0.6245869019428932, 67: 0.0, 68: 58.62771063094898, 69: 230.91763940269436, 70: 0.7495042813329503, 71: 5.006045463624338, 
                    72: 3.473217766866939, 73: 1469.0245761411184, 74: 1497.453780895026, 75: 2.5364773748919873, 76: 6.756841344610799, 77: 6.4477104943189065, 
                    78: 1.5111123410166714, 79: 43.718746037949664, 80: 485.474266689506, 81: 324.85668087270204, 82: 116.47468211998489, 83: 996.9877345815806, 
                    84: 1220.85014211092, 85: 505.21810610555406, 86: 2603.859771554181, 87: 2336.4212908071954, 88: 258.26855661542027, 89: 1429.5950916224788, 
                    90: 1871.9979791294502, 91: 872.9038743551225, 92: 552.0486883233608, 93: 12.085666626862842, 94: 0.0, 95: 0.0, 
                    96: 2.7529877830680713, 97: 2.059543992483289, 98: 0.0, 99: 0.0}

        self.assertEqual(water_constraints_by_farm, expected)


if __name__ == '__main__':
    unittest.main()
